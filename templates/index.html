<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performative Male Evaluator</title>
    <style>
        :root {
            /* Light Mode Colors */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --bg-secondary: rgba(255, 255, 255, 0.98);
            --bg-tertiary: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-card-hover: rgba(241, 245, 249, 1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border-color: #c7d2fe;
            --border-hover: #818cf8;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #ec4899;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --gradient-text: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 25px -5px rgba(99, 102, 241, 0.4);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --score-high: linear-gradient(135deg, #ec4899 0%, #f472b6 50%, #fb7185 100%);
            --score-medium: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%);
            --score-low: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            --error-bg: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            --error-text: #991b1b;
            --error-border: #fca5a5;
            --warning-bg: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            --warning-text: #92400e;
            --warning-border: #fcd34d;
            --roast-bg: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            --roast-text: #991b1b;
            --roast-border: #f87171;
        }

        [data-theme="dark"] {
            /* Dark Mode Colors */
            --bg-primary: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
            --bg-secondary: rgba(30, 41, 59, 0.95);
            --bg-tertiary: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --bg-card: rgba(30, 41, 59, 0.9);
            --bg-card-hover: rgba(51, 65, 85, 1);
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #475569;
            --border-hover: #6366f1;
            --accent-primary: #818cf8;
            --accent-secondary: #a78bfa;
            --accent-tertiary: #f472b6;
            --gradient-primary: linear-gradient(135deg, #818cf8 0%, #a78bfa 50%, #f472b6 100%);
            --gradient-text: linear-gradient(135deg, #818cf8 0%, #f472b6 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 25px -5px rgba(129, 140, 248, 0.3);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --score-high: linear-gradient(135deg, #f472b6 0%, #fb7185 50%, #f87171 100%);
            --score-medium: linear-gradient(135deg, #fbbf24 0%, #fcd34d 50%, #fde68a 100%);
            --score-low: linear-gradient(135deg, #34d399 0%, #6ee7b7 50%, #a7f3d0 100%);
            --error-bg: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            --error-text: #fecaca;
            --error-border: #dc2626;
            --warning-bg: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            --warning-text: #fde68a;
            --warning-border: #f59e0b;
            --roast-bg: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            --roast-text: #fecaca;
            --roast-border: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .theme-toggle #themeText {
                display: none;
            }

            .container {
                padding: 32px 24px;
            }
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-hover);
        }

        .theme-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover .theme-toggle-icon {
            transform: rotate(20deg);
        }

        .container {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255, 255, 255, 0.1);
            max-width: 900px;
            width: 100%;
            padding: 48px;
            animation: fadeIn 0.6s ease-out;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 2.75em;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: var(--gradient-text);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1.15em;
            font-weight: 400;
            line-height: 1.6;
        }

        .upload-area {
            border: 2.5px dashed var(--border-color);
            border-radius: 20px;
            padding: 48px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-tertiary);
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .upload-area.dragover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: scale(1.01);
            box-shadow: var(--shadow-lg);
        }

        .upload-icon {
            font-size: 3.5em;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        .upload-text {
            color: var(--accent-primary);
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .upload-hint {
            color: var(--text-tertiary);
            font-size: 0.95em;
            font-weight: 400;
        }

        #imageInput {
            display: none;
        }

        .preview-container {
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 450px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            border: 4px solid var(--bg-card);
        }

        .analyze-btn {
            background: var(--gradient-primary);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 1.15em;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            display: block;
            margin: 24px auto;
            box-shadow: var(--shadow-md);
            letter-spacing: -0.01em;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .analyze-btn:active {
            transform: translateY(-1px);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 32px;
            font-size: 3.5em;
            font-weight: 800;
            color: white;
            background: var(--gradient-primary);
            background-size: 200% 200%;
            animation: gradientShift 4s ease infinite;
            box-shadow: var(--shadow-lg), inset 0 0 0 8px rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .score-circle.score-high {
            background: var(--score-high);
        }

        .score-circle.score-medium {
            background: var(--score-medium);
        }

        .score-circle.score-low {
            background: var(--score-low);
        }

        .score-circle::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            padding: 4px;
            background: var(--gradient-primary);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .score-circle:hover::before {
            opacity: 0.3;
        }

        .score-label {
            font-size: 0.28em;
            opacity: 0.95;
            margin-top: 12px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .score-percentage {
            font-size: 1em;
            letter-spacing: -0.02em;
        }

        .detected-items {
            background: var(--bg-tertiary);
            border-radius: 16px;
            padding: 28px;
            margin-top: 32px;
            border: 1px solid var(--border-color);
        }

        .detected-items h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .item-list {
            list-style: none;
            padding: 0;
            display: grid;
            gap: 12px;
        }

        .item-list li {
            padding: 14px 18px;
            margin: 0;
            background: var(--bg-card);
            border-radius: 10px;
            border-left: 4px solid var(--accent-primary);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .item-list li:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--accent-secondary);
        }

        .category-badge {
            display: inline-block;
            background: var(--gradient-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            margin: 6px 8px 6px 0;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .category-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .loading {
            text-align: center;
            padding: 32px;
            display: none;
        }

        .loading.show {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .loading p {
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: 16px;
            font-size: 1.05em;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
            box-shadow: var(--shadow-sm);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 24px;
            display: none;
            border: 1px solid var(--error-border);
            box-shadow: var(--shadow-sm);
            font-weight: 500;
        }

        .error.show {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .improvement-suggestions {
            background: var(--warning-bg);
            border-radius: 16px;
            padding: 28px;
            margin-top: 32px;
            border: 1px solid var(--warning-border);
            box-shadow: var(--shadow-sm);
        }

        .improvement-suggestions h3 {
            color: var(--warning-text);
            margin-bottom: 12px;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .improvement-intro {
            color: var(--warning-text);
            margin-bottom: 20px;
            font-style: italic;
            font-weight: 400;
            opacity: 0.9;
        }

        .improvement-list {
            list-style: none;
            padding: 0;
            display: grid;
            gap: 12px;
        }

        .improvement-list li {
            padding: 16px 18px 16px 48px;
            margin: 0;
            background: var(--bg-card);
            border-radius: 10px;
            border-left: 4px solid var(--warning-border);
            position: relative;
            transition: all 0.2s ease;
            color: var(--warning-text);
            line-height: 1.6;
            box-shadow: var(--shadow-sm);
        }

        .improvement-list li:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--warning-border);
        }

        .improvement-list li::before {
            content: "üí°";
            position: absolute;
            left: 16px;
            font-size: 1.3em;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .improvement-list li:empty {
            display: none;
        }

        .roasts-section {
            background: var(--roast-bg);
            border-radius: 16px;
            padding: 28px;
            margin-top: 32px;
            border: 1px solid var(--roast-border);
            box-shadow: var(--shadow-sm);
        }

        .roasts-section h3 {
            color: var(--roast-text);
            margin-bottom: 12px;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .roasts-intro {
            color: var(--roast-text);
            margin-bottom: 20px;
            font-style: italic;
            font-weight: 400;
            opacity: 0.9;
        }

        .roasts-list {
            list-style: none;
            padding: 0;
            display: grid;
            gap: 12px;
        }

        .roasts-list li {
            padding: 16px 18px 16px 48px;
            margin: 0;
            background: var(--bg-card);
            border-radius: 10px;
            border-left: 4px solid var(--roast-border);
            position: relative;
            transition: all 0.2s ease;
            color: var(--roast-text);
            line-height: 1.6;
            box-shadow: var(--shadow-sm);
        }

        .roasts-list li:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--roast-border);
        }

        .roasts-list li::before {
            content: "üî•";
            position: absolute;
            left: 16px;
            font-size: 1.3em;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .roasts-list li:empty {
            display: none;
        }

        .mode-toggle {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .mode-btn {
            padding: 10px 24px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            color: var(--accent-primary);
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        .mode-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .mode-btn:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .camera-container {
            display: none !important;
            text-align: center;
            margin-bottom: 24px;
            width: 100%;
        }

        .camera-container.active {
            display: block !important;
            visibility: visible !important;
        }

        .camera-preview {
            width: 100%;
            max-width: 100%;
            max-height: 450px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 16px;
            border: 4px solid var(--bg-card);
            background: #000;
            object-fit: cover;
            display: block;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .camera-btn.capture {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }

        .camera-btn.capture:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
        }

        .camera-btn.stop {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
        }

        .camera-btn.stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.4);
        }

        .camera-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .camera-error {
            color: var(--error-text);
            margin-top: 12px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <span class="theme-toggle-icon" id="themeIcon">üåô</span>
        <span id="themeText">Dark Mode</span>
    </button>
    <div class="container">
        <h1>üé≠ Performative Male Evaluator</h1>
        <p class="subtitle">Upload an image or take a photo to analyze performativeness percentage</p>

        <div class="mode-toggle">
            <button class="mode-btn active" id="uploadModeBtn" data-mode="upload">
                üìÅ Upload Image
            </button>
            <button class="mode-btn" id="cameraModeBtn" data-mode="camera">
                üì∑ Take Photo
            </button>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì∏</div>
            <div class="upload-text">Click or drag image here</div>
            <div class="upload-hint">Supports JPG, PNG, and other image formats</div>
            <input type="file" id="imageInput" accept="image/*">
        </div>

        <div class="camera-container" id="cameraContainer">
            <video id="cameraPreview" class="camera-preview" autoplay playsinline muted></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div class="camera-controls">
                <button class="camera-btn capture" id="captureBtn" disabled>üì∏ Capture Photo</button>
                <button class="camera-btn stop" id="stopCameraBtn" disabled>Stop Camera</button>
            </div>
            <div class="camera-error" id="cameraError"></div>
        </div>

        <div class="preview-container" id="previewContainer" style="display: none;">
            <img id="previewImage" class="preview-image" alt="Preview">
            <button class="analyze-btn" id="analyzeBtn">Analyze Image</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing image with Gemini Vision AI...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <div class="score-container">
                <div class="score-circle">
                    <div>
                        <span class="score-percentage" id="scorePercentage">0%</span>
                        <div class="score-label">Performativeness Score</div>
                    </div>
                </div>
            </div>

            <div class="detected-items">
                <h3>Detected Characteristics</h3>
                <div id="categoryBadges"></div>
                <h3 style="margin-top: 20px;">Detected Items</h3>
                <ul class="item-list" id="itemList"></ul>
            </div>

            <div class="roasts-section" id="roastsSection" style="display: none;">
                <h3>üî• The Roast</h3>
                <p class="roasts-intro" id="roastsIntro">Oof, this score is rough. Here's what we think:</p>
                <ul class="roasts-list" id="roastsList"></ul>
            </div>

            <div class="improvement-suggestions" id="improvementSection" style="display: none;">
                <h3>üöÄ How to Reach 100%</h3>
                <p class="improvement-intro" id="improvementIntro">Here's how you can improve your performativeness score:</p>
                <ul class="improvement-list" id="improvementList"></ul>
            </div>
        </div>
    </div>

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const htmlElement = document.documentElement;

        // Get saved theme from localStorage or use system preference
        function getInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                return savedTheme;
            }
            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            return 'light';
        }

        const initialTheme = getInitialTheme();
        htmlElement.setAttribute('data-theme', initialTheme);
        updateThemeUI(initialTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeUI(newTheme);
        });

        function updateThemeUI(theme) {
            if (theme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
            }
        }

        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const scorePercentage = document.getElementById('scorePercentage');
        const categoryBadges = document.getElementById('categoryBadges');
        const itemList = document.getElementById('itemList');
        const improvementSection = document.getElementById('improvementSection');
        const improvementList = document.getElementById('improvementList');
        const roastsSection = document.getElementById('roastsSection');
        const roastsList = document.getElementById('roastsList');
        
        // Camera elements
        const uploadModeBtn = document.getElementById('uploadModeBtn');
        const cameraModeBtn = document.getElementById('cameraModeBtn');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const cameraError = document.getElementById('cameraError');

        let currentImageData = null;
        let currentStream = null;
        let currentMode = 'upload';

        // Mode toggle
        uploadModeBtn.addEventListener('click', () => switchMode('upload'));
        cameraModeBtn.addEventListener('click', () => switchMode('camera'));

        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'upload') {
                uploadModeBtn.classList.add('active');
                cameraModeBtn.classList.remove('active');
                uploadArea.style.display = 'block';
                cameraContainer.classList.remove('active');
                stopCamera();
            } else {
                cameraModeBtn.classList.add('active');
                uploadModeBtn.classList.remove('active');
                uploadArea.style.display = 'none';
                
                // Force display the camera container
                cameraContainer.style.display = 'block';
                cameraContainer.classList.add('active');
                
                // Ensure video element is visible
                cameraPreview.style.display = 'block';
                cameraPreview.style.visibility = 'visible';
                
                console.log('Camera container should be visible now');
                console.log('Container display:', window.getComputedStyle(cameraContainer).display);
                console.log('Video element:', cameraPreview);
                
                // Wait a bit longer and ensure element is in view before starting camera
                setTimeout(() => {
                    // Double check visibility
                    const rect = cameraContainer.getBoundingClientRect();
                    console.log('Camera container rect:', rect);
                    
                    if (rect.width > 0 && rect.height > 0) {
                        console.log('Container is visible, starting camera...');
                        startCamera();
                    } else {
                        console.error('Container is not visible!');
                        cameraError.textContent = 'Camera container is not visible. Please refresh the page.';
                    }
                }, 300);
            }
            
            // Clear preview and results when switching modes
            previewContainer.style.display = 'none';
            results.classList.remove('show');
            error.classList.remove('show');
            roastsSection.style.display = 'none';
            improvementSection.style.display = 'none';
            currentImageData = null;
        }

        async function startCamera() {
            console.log('=== STARTING CAMERA ===');
            cameraError.textContent = '';
            captureBtn.disabled = true;
            stopCameraBtn.disabled = true;
            
            // Stop any existing stream first
            if (currentStream) {
                console.log('Stopping existing stream...');
                stopCamera();
                // Wait a moment for stream to fully stop
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Check if we're on a secure context (HTTPS or localhost)
            const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            console.log('Secure context:', isSecureContext, 'Protocol:', location.protocol, 'Hostname:', location.hostname);
            
            if (!isSecureContext) {
                cameraError.textContent = 'Camera access requires HTTPS or localhost. Please use HTTPS or run on localhost.';
                console.error('Not a secure context!');
                return;
            }
            
            try {
                // Check if getUserMedia is supported
                if (!navigator.mediaDevices) {
                    throw new Error('navigator.mediaDevices is not available. Your browser may not support camera access.');
                }
                
                if (!navigator.mediaDevices.getUserMedia) {
                    throw new Error('getUserMedia is not available. Your browser may not support camera access.');
                }
                
                console.log('getUserMedia is available');
                
                // First, try with simple constraints to ensure we get permission prompt
                console.log('Requesting camera access with simple constraints...');
                let stream;
                
                try {
                    // Start with simplest possible constraints
                    const simpleConstraints = { video: true };
                    console.log('Trying constraints:', simpleConstraints);
                    stream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
                    console.log('‚úì Camera stream obtained with simple constraints');
                } catch (simpleErr) {
                    console.log('Simple constraints failed:', simpleErr.name, simpleErr.message);
                    
                    // Try with front-facing camera preference
                    try {
                        const constraints = {
                            video: {
                                facingMode: 'user'
                            }
                        };
                        console.log('Trying constraints:', constraints);
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        console.log('‚úì Camera stream obtained with front-facing preference');
                    } catch (frontErr) {
                        console.log('Front-facing failed:', frontErr.name, frontErr.message);
                        throw simpleErr; // Throw the original error
                    }
                }
                
                if (!stream) {
                    throw new Error('Failed to obtain camera stream');
                }
                
                console.log('Stream obtained:', stream);
                console.log('Video tracks:', stream.getVideoTracks());
                
                currentStream = stream;
                
                // Set the stream to the video element
                cameraPreview.srcObject = stream;
                console.log('Stream assigned to video element');
                
                // Ensure video element is ready
                if (cameraPreview.readyState >= 2) {
                    // Video is already loaded
                    console.log('Video ready state:', cameraPreview.readyState);
                    try {
                        await cameraPreview.play();
                        console.log('‚úì Video is playing');
                        captureBtn.disabled = false;
                        stopCameraBtn.disabled = false;
                        cameraError.textContent = '';
                    } catch (playErr) {
                        console.error('Error playing video:', playErr);
                        cameraError.textContent = 'Error playing video. Please try again.';
                    }
                } else {
                    // Wait for video to load
                    cameraPreview.onloadedmetadata = async () => {
                        console.log('Video metadata loaded, readyState:', cameraPreview.readyState);
                        try {
                            await cameraPreview.play();
                            console.log('‚úì Video is playing after metadata load');
                            captureBtn.disabled = false;
                            stopCameraBtn.disabled = false;
                            cameraError.textContent = '';
                        } catch (playErr) {
                            console.error('Error playing video after metadata:', playErr);
                            cameraError.textContent = 'Error playing video. Please try again.';
                        }
                    };
                    
                    // Also try to play immediately (in case metadata is already loaded)
                    cameraPreview.play().then(() => {
                        console.log('‚úì Video started playing immediately');
                        captureBtn.disabled = false;
                        stopCameraBtn.disabled = false;
                        cameraError.textContent = '';
                    }).catch(err => {
                        console.log('Immediate play failed, waiting for metadata...', err);
                    });
                }
                
                // Handle stream ending
                stream.getVideoTracks().forEach(track => {
                    track.addEventListener('ended', () => {
                        console.log('Camera track ended');
                        stopCamera();
                        cameraError.textContent = 'Camera stream ended. Click "Take Photo" again to restart.';
                    });
                });
                
                // Handle errors on the video element
                cameraPreview.onerror = (err) => {
                    console.error('Video element error:', err);
                    cameraError.textContent = 'Error displaying camera preview. Please try again.';
                };
                
                // Monitor video element state
                cameraPreview.addEventListener('playing', () => {
                    console.log('‚úì Video is now playing');
                    cameraError.textContent = '';
                });
                
                cameraPreview.addEventListener('error', (e) => {
                    console.error('Video error event:', e);
                });
                
            } catch (err) {
                console.error('=== CAMERA ERROR ===');
                console.error('Error name:', err.name);
                console.error('Error message:', err.message);
                console.error('Full error:', err);
                
                let errorMessage = 'Unable to access camera. ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage = 'Camera permission denied. Please allow camera access in your browser settings and try again.';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage = 'No camera found on your device. Please use the upload option instead.';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage = 'Camera is being used by another application. Please close other apps using the camera and try again.';
                } else if (err.name === 'OverconstrainedError') {
                    errorMessage = 'Camera constraints not supported by your device.';
                } else if (err.name === 'SecurityError') {
                    errorMessage = 'Camera access blocked due to security restrictions. Please use HTTPS or localhost.';
                } else if (err.name === 'TypeError') {
                    errorMessage = 'Camera API not available. Your browser may not support camera access.';
                } else {
                    errorMessage += err.message || 'Unknown error. Please check browser console for details.';
                }
                
                cameraError.textContent = errorMessage;
                captureBtn.disabled = true;
                stopCameraBtn.disabled = true;
                
                // Show error in main error area too
                showError(errorMessage);
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('Stopped track:', track.kind);
                });
                currentStream = null;
            }
            if (cameraPreview) {
                cameraPreview.srcObject = null;
                cameraPreview.onloadedmetadata = null;
                cameraPreview.onerror = null;
            }
            captureBtn.disabled = true;
            stopCameraBtn.disabled = true;
        }

        stopCameraBtn.addEventListener('click', stopCamera);

        captureBtn.addEventListener('click', () => {
            if (!currentStream) return;
            
            // Set canvas dimensions to match video
            cameraCanvas.width = cameraPreview.videoWidth;
            cameraCanvas.height = cameraPreview.videoHeight;
            
            // Draw video frame to canvas
            const ctx = cameraCanvas.getContext('2d');
            ctx.drawImage(cameraPreview, 0, 0);
            
            // Convert canvas to base64 image
            const imageData = cameraCanvas.toDataURL('image/jpeg', 0.9);
            
            // Use the captured image
            currentImageData = imageData;
            previewImage.src = imageData;
            previewContainer.style.display = 'block';
            results.classList.remove('show');
            error.classList.remove('show');
            
            // Stop camera after capture
            stopCamera();
            
            // Switch back to upload mode to show the preview and analyze button
            uploadModeBtn.classList.add('active');
            cameraModeBtn.classList.remove('active');
            cameraContainer.classList.remove('active');
            uploadArea.style.display = 'block';
            currentMode = 'upload';
        });

        // Upload area click
        uploadArea.addEventListener('click', () => {
            if (currentMode === 'upload') {
                imageInput.click();
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });

        // File input change
        imageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;
                previewImage.src = currentImageData;
                previewContainer.style.display = 'block';
                results.classList.remove('show');
                error.classList.remove('show');
            };
            reader.readAsDataURL(file);
        }

        // Analyze button
        analyzeBtn.addEventListener('click', async () => {
            if (!currentImageData) {
                showError('Please upload an image first');
                return;
            }

            loading.classList.add('show');
            results.classList.remove('show');
            error.classList.remove('show');
            analyzeBtn.disabled = true;

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: currentImageData
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                displayResults(data);
            } catch (err) {
                showError(err.message);
            } finally {
                loading.classList.remove('show');
                analyzeBtn.disabled = false;
            }
        });

        function displayResults(data) {
            scorePercentage.textContent = data.percentage + '%';
            
            // Update score circle color based on percentage
            const scoreCircle = document.querySelector('.score-circle');
            scoreCircle.classList.remove('score-high', 'score-medium', 'score-low');
            
            if (data.percentage >= 70) {
                scoreCircle.classList.add('score-high');
            } else if (data.percentage >= 40) {
                scoreCircle.classList.add('score-medium');
            } else {
                scoreCircle.classList.add('score-low');
            }
            scoreCircle.style.backgroundSize = '200% 200%';

            // Display category badges
            categoryBadges.innerHTML = '';
            if (data.category_details && data.category_details.length > 0) {
                data.category_details.forEach(category => {
                    const badge = document.createElement('span');
                    badge.className = 'category-badge';
                    badge.textContent = category.name + ` (+${category.weight}pts)`;
                    categoryBadges.appendChild(badge);
                });
            } else {
                categoryBadges.innerHTML = '<p style="color: var(--text-tertiary);">No characteristics detected</p>';
            }

            // Display detected items
            itemList.innerHTML = '';
            if (data.detected_items && data.detected_items.length > 0) {
                data.detected_items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    itemList.appendChild(li);
                });
            } else {
                itemList.innerHTML = '<li style="color: var(--text-tertiary);">No items detected</li>';
            }

            // Display roasts if score is below 30%
            roastsList.innerHTML = '';
            console.log('üî• Roast Check - Percentage:', data.percentage, 'Roasts:', data.roasts);
            
            // Check if roasts should be displayed (score < 30%)
            if (data.percentage < 30) {
                if (data.roasts && Array.isArray(data.roasts) && data.roasts.length > 0) {
                    console.log('‚úÖ Displaying', data.roasts.length, 'roasts for score', data.percentage + '%');
                    data.roasts.forEach(roast => {
                        if (roast && roast.trim()) {
                            const li = document.createElement('li');
                            li.textContent = roast;
                            roastsList.appendChild(li);
                        }
                    });
                    
                    // Only show if we actually added roasts to the list
                    if (roastsList.children.length > 0) {
                        roastsSection.style.display = 'block';
                        console.log('‚úÖ Roasts section is now visible');
                    } else {
                        console.warn('‚ö†Ô∏è No valid roasts to display');
                        roastsSection.style.display = 'none';
                    }
                } else {
                    console.warn('‚ö†Ô∏è Score is < 30% but no roasts in response. Roasts:', data.roasts);
                    roastsSection.style.display = 'none';
                }
            } else {
                console.log('‚ÑπÔ∏è Score is', data.percentage + '% (>= 30%), no roasts will be shown');
                roastsSection.style.display = 'none';
            }

            // Display improvement suggestions (only if score is less than 100%)
            improvementList.innerHTML = '';
            if (data.percentage >= 100) {
                improvementSection.style.display = 'none';
            } else if (data.improvement_suggestions && data.improvement_suggestions.length > 0) {
                // Display all suggestions (they should already be formatted properly)
                data.improvement_suggestions.forEach(suggestion => {
                    // Skip very short or header-like messages
                    if (suggestion.length > 15 && !suggestion.toLowerCase().includes('focus on adding these high-value items')) {
                        const li = document.createElement('li');
                        li.textContent = suggestion;
                        improvementList.appendChild(li);
                    }
                });
                
                // If no suggestions were added, show a fallback
                if (improvementList.children.length === 0) {
                    improvementList.innerHTML = '<li>Keep adding performative items to reach 100%! Focus on high-value items like feminist literature, tote bags, and matcha lattes.</li>';
                }
                
                improvementSection.style.display = 'block';
            } else {
                // Fallback message if no suggestions
                improvementSection.style.display = 'block';
                improvementList.innerHTML = '<li>Keep adding performative items to reach 100%! Focus on high-value items like feminist literature, tote bags, and matcha lattes.</li>';
            }

            results.classList.add('show');
        }

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
        }
    </script>
</body>
</html>

